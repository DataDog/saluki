//! Generated telemetry container.

use std::time::{Duration, Instant};

use otlp_protos::opentelemetry::proto::{
    collector::{
        logs::v1::ExportLogsServiceRequest, metrics::v1::ExportMetricsServiceRequest,
        trace::v1::ExportTraceServiceRequest,
    },
    logs::v1::ResourceLogs,
    metrics::v1::ResourceMetrics,
    trace::v1::ResourceSpans,
};

/// Telemetry generated by a single service, with a target send time.
///
/// In a real distributed system, each service sends its telemetry independently
/// when it finishes processing. This struct captures telemetry for one service
/// along with when it should be sent to simulate realistic behavior.
pub struct ServiceTelemetry {
    /// The service name (for debugging/logging).
    pub service_name: String,

    /// Trace spans for this service (typically one span per request).
    pub resource_spans: Option<ResourceSpans>,

    /// Metrics for this service.
    pub resource_metrics: Option<ResourceMetrics>,

    /// Logs for this service.
    pub resource_logs: Option<ResourceLogs>,

    /// When this telemetry should be sent (as a Duration from simulation start).
    ///
    /// This represents when the service "finished" processing and would send its data.
    pub send_after: Duration,
}

impl ServiceTelemetry {
    /// Returns true if there is any telemetry to send.
    pub fn has_data(&self) -> bool {
        self.resource_spans.is_some() || self.resource_metrics.is_some() || self.resource_logs.is_some()
    }
}

/// A batch of service telemetry items ready to be sent.
///
/// Used for accumulating telemetry that has the same send time or for
/// batching multiple items together for efficiency.
#[derive(Default)]
pub struct TelemetryBatch {
    /// Trace spans grouped by resource.
    pub resource_spans: Vec<ResourceSpans>,

    /// Metrics grouped by resource.
    pub resource_metrics: Vec<ResourceMetrics>,

    /// Logs grouped by resource.
    pub resource_logs: Vec<ResourceLogs>,
}

impl TelemetryBatch {
    /// Creates a new empty batch.
    pub fn new() -> Self {
        Self::default()
    }

    /// Adds service telemetry to this batch.
    pub fn add(&mut self, telemetry: ServiceTelemetry) {
        if let Some(spans) = telemetry.resource_spans {
            self.resource_spans.push(spans);
        }
        if let Some(metrics) = telemetry.resource_metrics {
            self.resource_metrics.push(metrics);
        }
        if let Some(logs) = telemetry.resource_logs {
            self.resource_logs.push(logs);
        }
    }

    /// Returns true if there are any traces to send.
    pub fn has_traces(&self) -> bool {
        !self.resource_spans.is_empty()
    }

    /// Returns true if there are any metrics to send.
    pub fn has_metrics(&self) -> bool {
        !self.resource_metrics.is_empty()
    }

    /// Returns true if there are any logs to send.
    pub fn has_logs(&self) -> bool {
        !self.resource_logs.is_empty()
    }

    /// Converts traces to an export request, consuming them.
    pub fn take_trace_request(&mut self) -> ExportTraceServiceRequest {
        ExportTraceServiceRequest {
            resource_spans: std::mem::take(&mut self.resource_spans),
        }
    }

    /// Converts metrics to an export request, consuming them.
    pub fn take_metrics_request(&mut self) -> ExportMetricsServiceRequest {
        ExportMetricsServiceRequest {
            resource_metrics: std::mem::take(&mut self.resource_metrics),
        }
    }

    /// Converts logs to an export request, consuming them.
    pub fn take_logs_request(&mut self) -> ExportLogsServiceRequest {
        ExportLogsServiceRequest {
            resource_logs: std::mem::take(&mut self.resource_logs),
        }
    }
}

/// Result of simulating a request through the service graph.
///
/// Contains telemetry for each service that participated in handling the request,
/// each with its own target send time.
pub struct SimulationResult {
    /// Telemetry items to be enqueued for sending, one per service.
    pub telemetry_items: Vec<ServiceTelemetry>,
}

impl SimulationResult {
    /// Creates a new simulation result.
    pub fn new(_simulation_start: Instant) -> Self {
        Self {
            telemetry_items: Vec::new(),
        }
    }

    /// Adds telemetry for a service.
    pub fn add(&mut self, telemetry: ServiceTelemetry) {
        self.telemetry_items.push(telemetry);
    }
}
