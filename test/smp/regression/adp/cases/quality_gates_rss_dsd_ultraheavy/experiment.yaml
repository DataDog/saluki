optimization_goal: ingress_throughput
erratic: false

target:
  name: agent-data-plane
  command: /usr/local/bin/agent-data-plane run --config=/etc/agent-data-plane/empty.yaml
  cpu_allotment: 4
  memory_allotment: 2GiB

  environment:
    # Dummy, self-signed certificate since we're not running alongside the Datadog Agent which
    # would otherwise be providing the IPC certificate.
    DD_IPC_CERT_FILE_PATH: /etc/agent-data-plane/cert.pem

    DD_API_KEY: foo00000001
    DD_HOSTNAME: smp-regression
    DD_DD_URL: http://127.0.0.1:9091

    # Sets the context resolver's string interner size.
    DD_DOGSTATSD_STRING_INTERNER_SIZE: "64MiB"

    # Set the context limit in the aggregator to right above 250K, which matches the maximum number of contexts we
    # expect to generate. We essentially don't want the aggregator to be a limiting factor.
    DD_AGGREGATE_CONTEXT_LIMIT: "250100"

    # Disables UDP and enables listening on UDS in SOCK_DGRAM mode.
    DD_DOGSTATSD_PORT: "0"
    DD_DOGSTATSD_SOCKET: /tmp/adp-dogstatsd-dgram.sock

    # Runs ADP in standalone mode, which decouples ADP from any dependency on the Datadog Agent.
    DD_ADP_STANDALONE_MODE: "true"

    # Enable internal telemetry endpoint.
    DD_TELEMETRY_ENABLED: "true"
    DD_PROMETHEUS_LISTEN_ADDR: tcp://127.0.0.1:5102

checks:
  - name: memory_usage
    description: "Acceptable upper bound on the memory used by ADP when handling 'ultraheavy' DSD traffic."
    bounds:
      series: total_rss_bytes
      upper_bound: "200.0 MiB"

report_links:
  - text: (metrics)
    link: "https://app.datadoghq.com/dashboard/4br-nxz-khi?fromUser=true&refresh_mode=paused&tpl_var_adp-run-id%5B0%5D={{ job_id }}&tpl_var_experiment%5B0%5D={{ experiment }}&view=spans&from_ts={{ start_time_ms }}&to_ts={{ end_time_ms }}&live=false"
  - text: (profiles)
    link: "https://app.datadoghq.com/profiling/explorer?query=env%3Asingle-machine-performance%20service%3Aagent-data-plane%20job_id%3A{{ job_id }}%20experiment%3A{{ experiment }}&agg_m=count&agg_m_source=base&agg_t=count&fromUser=false&viz=stream&start={{ filter_start }}&end={{ filter_end }}&paused=true"
  - text: (logs)
    link: "https://app.datadoghq.com/logs?query=experiment%3A{{ experiment }}%20run_id%3A{{ job_id }}&agg_m=count&agg_m_source=base&agg_q=%40span.url&agg_q_source=base&agg_t=count&fromUser=true&index=single-machine-performance-target-logs&messageDisplay=inline&refresh_mode=paused&storage=hot&stream_sort=time%2Cdesc&top_n=100&top_o=top&viz=stream&x_missing=true&from_ts={{ filter_start }}&to_ts={{ filter_end }}&live=false"
