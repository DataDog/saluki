include:
  - .gitlab/*.yml

stages:
  - test
  - build
  - benchmark
  - internal

variables:
  # High-level repository paths we build off of, and dedicated images needed for various jobs.
  IMAGE_REGISTRY: "registry.ddbuild.io"
  DOCKER_BUILD_IMAGE: "486234852809.dkr.ecr.us-east-1.amazonaws.com/docker:20.10-py3"
  GBI_BASE_IMAGE: "${IMAGE_REGISTRY}/images/base/gbi-ubuntu_2204:release"

  # Base repository paths for where our CI images go, whether they're helper images or actual
  # output artifacts like ADP itself.
  SALUKI_IMAGE_REPO_BASE: "${IMAGE_REGISTRY}/saluki"
  # Build image built from https://gitlab.ddbuild.io/DataDog/saluki/-/jobs/683779080
  SALUKI_BUILD_CI_IMAGE: "${SALUKI_IMAGE_REPO_BASE}/build-ci:v47392904-45d66c50"
  # CI image built from https://gitlab.ddbuild.io/DataDog/saluki/-/jobs/683779084
  SALUKI_SMP_CI_IMAGE: "${SALUKI_IMAGE_REPO_BASE}/smp-ci:v47392904-45d66c50"
  # 'general' image built with dd-python-libs
  # registry.ddbuild.io/saluki/general-ci:v47148172-419daeb2
  # from https://gitlab.ddbuild.io/DataDog/saluki/-/jobs/680099601


  # ADP-specific variables, controlling how we build ADP images, how we version them, and where we push them.
  ADP_VERSION_BASE: "0.1.0"
  ADP_IMAGE_BASE: "${SALUKI_IMAGE_REPO_BASE}/agent-data-plane"

  # Converged Datadog Agent-specific variables, which control how we build the converged Datadog Agent image
  # used internally for testing.
  DD_AGENT_VERSION: "7-58-0-jmx"
  DD_AGENT_IMAGE_BASE: "${IMAGE_REGISTRY}/datadog-agent"
  DD_AGENT_IMAGE: "${DD_AGENT_IMAGE_BASE}:${DD_AGENT_VERSION}"

.setup-env: &setup-env
  - 'export ADP_VERSION="${ADP_VERSION_BASE}"'
  - '[ -z "$CI_COMMIT_TAG" ] && export ADP_VERSION="${ADP_VERSION_BASE}-beta-${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}"'
  - '[ "$CI_PIPELINE_SOURCE" == "schedule" ] && export ADP_VERSION="${ADP_VERSION_BASE}-nightly-${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}"'
  - echo $ADP_VERSION

default:
  tags: ["arch:amd64"]
  before_script:
    - *setup-env
