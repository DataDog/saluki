.setup-smp-env: &setup-smp-env
  - export AWS_NAMED_PROFILE=single-machine-performance
  - export SMP_VERSION=0.25.1
  - export RUST_LOG=info,aws_config::profile::credentials=error
  - export SMP_ACCOUNT_ID=$(aws ssm get-parameter --region us-east-1 --name ci.saluki.smp-account-id --with-decryption --query "Parameter.Value" --out text)
  - export SMP_TEAM_ID=$(aws ssm get-parameter --region us-east-1 --name ci.saluki.smp-team-id --with-decryption --query "Parameter.Value" --out text)
  - export SINGLE_MACHINE_PERFORMANCE_API=$(aws ssm get-parameter --region us-east-1 --name ci.saluki.smp-api --with-decryption --query "Parameter.Value" --out text)
  - export SMP_ECR_HOST="${SMP_ACCOUNT_ID}.dkr.ecr.us-west-2.amazonaws.com"
  - export SMP_SALUKI_IMAGE_BASE="${SMP_ECR_HOST}/${SMP_TEAM_ID}-saluki"
  - export SMP_ADP_IMAGE_TAG="adp-${CI_PIPELINE_ID}"
  - export SMP_ADP_IMAGE_BASE="${SMP_SALUKI_IMAGE_BASE}:${SMP_ADP_IMAGE_TAG}"
  - git fetch --verbose --deepen=999 origin ${CI_COMMIT_BRANCH} main

build-adp-baseline-image:
  extends: .build-common-variables
  stage: benchmark
  tags: ["arch:amd64"]
  # Don't run benchmarks unless it's a PR, basically.
  rules:
    - if: !reference [.on_mq_branch, rules, if]
      when: never
    - if: !reference [.on_development_branch, rules, if]
  image: "${SALUKI_BUILD_CI_IMAGE}"
  needs: []
  retry: 2
  timeout: 15m
  before_script:
    - *setup-smp-env
  script:
    # Initialize our AWS credentials.
    - ./test/smp/configure-smp-aws-credentials.sh
    # Checkout the baseline commit and define the relevant variables
    #
    # We use the merge base of the current branch, relative to `main`. This means that for stacked PRs, we won't be
    # benchmarking against the mid-stack PR, but that's an acceptable tradeoff for the moment.
    - export BASELINE_ADP_SHA=$(git merge-base origin/main origin/${CI_COMMIT_BRANCH})
    - export BASELINE_ADP_IMG="${SMP_ADP_IMAGE_BASE}-${BASELINE_ADP_SHA}"
    - git switch --detach ${BASELINE_ADP_SHA}
    # Actually build and push our image to the SMP ECR.
    - aws ecr get-login-password --region us-west-2 --profile ${AWS_NAMED_PROFILE} | docker login --username AWS --password-stdin ${SMP_ECR_HOST}
    - ADP_BUILD_PROFILE=optimized-release
      ADP_IMAGE_OUTPUT="type=registry"
      ADP_IMAGE_BASE=${SMP_ADP_IMAGE_BASE}
      ADP_IMAGE_TAG=${SMP_ADP_IMAGE_TAG}
      ADP_IMAGE_TAG_SUFFIX="-${BASELINE_ADP_SHA}"
      ADP_APP_IMAGE=${APP_IMAGE}
      make build-adp-image
    # Generate our image SHA/path for the runner job to use.
    - echo "BASELINE_ADP_SHA=${BASELINE_ADP_SHA}" >> smp-vars.env
    - echo "BASELINE_ADP_IMG=${BASELINE_ADP_IMG}" >> smp-vars.env
  artifacts:
    reports:
      dotenv: smp-vars.env

build-adp-comparison-image:
  extends: .build-common-variables
  stage: benchmark
  tags: ["arch:amd64"]
  # Don't run benchmarks unless it's a PR, basically.
  rules:
    - if: !reference [.on_mq_branch, rules, if]
      when: never
    - if: !reference [.on_development_branch, rules, if]
  image: "${SALUKI_BUILD_CI_IMAGE}"
  needs: []
  retry: 2
  timeout: 15m
  before_script:
    - *setup-smp-env
  script:
    # Initialize our AWS credentials.
    - ./test/smp/configure-smp-aws-credentials.sh
    # Checkout the comparison commit and define the relevant variables.
    - export COMPARISON_ADP_SHA=${CI_COMMIT_SHA}
    - export COMPARISON_ADP_IMG="${ADP_IMG_BASE}-${COMPARISON_ADP_SHA}"
    - git switch --detach ${COMPARISON_ADP_SHA}
    # Actually build and push our image to the SMP ECR.
    - aws ecr get-login-password --region us-west-2 --profile ${AWS_NAMED_PROFILE} | docker login --username AWS --password-stdin ${SMP_ECR_HOST}
    - ADP_BUILD_PROFILE=optimized-release
      ADP_IMAGE_OUTPUT="type=registry"
      ADP_IMAGE_BASE=${SMP_ADP_IMAGE_BASE}
      ADP_IMAGE_TAG=${SMP_ADP_IMAGE_TAG}
      ADP_IMAGE_TAG_SUFFIX="-${COMPARISON_ADP_SHA}"
      ADP_APP_IMAGE=${APP_IMAGE}
      make build-adp-image
    # Generate our image SHA/path for the runner job to use.
    - echo "COMPARISON_ADP_SHA=${COMPARISON_ADP_SHA}" >> smp-vars.env
    - echo "COMPARISON_ADP_IMG=${COMPARISON_ADP_IMG}" >> smp-vars.env
  artifacts:
    reports:
      dotenv: smp-vars.env

run-benchmarks-adp:
  stage: benchmark
  # Don't run benchmarks unless it's a PR, basically.
  rules:
    - if: !reference [.on_mq_branch, rules, if]
      when: never
    - if: !reference [.on_development_branch, rules, if]
  timeout: 1h
  needs:
    - build-adp-baseline-image
    - build-adp-comparison-image
  image: "${SALUKI_BUILD_CI_IMAGE}"
  before_script:
    - *setup-smp-env
  artifacts:
    expire_in: 1 weeks
    paths:
      - submission_metadata # for provenance, debugging
      - outputs/report.md # for debugging, also on S3
      - outputs/report.html # for debugging, also on S3
    when: always
  script:
    # Do some pre-flight steps like creating directories, installing helper utilities, setting credentials, and so on.
    - mkdir outputs && touch outputs/report.md outputs/report.html
    - ./test/smp/configure-smp-aws-credentials.sh
    # Download the SMP binary.
    - aws --profile ${AWS_NAMED_PROFILE} s3 cp s3://smp-cli-releases/v${SMP_VERSION}/x86_64-unknown-linux-musl/smp smp && chmod +x smp
    # Trigger the SMP job run.
    - ./smp --team-id ${SMP_TEAM_ID} --aws-named-profile ${AWS_NAMED_PROFILE}
      job submit
      --warmup-seconds 0
      --baseline-image ${BASELINE_ADP_IMG}
      --comparison-image ${COMPARISON_ADP_IMG}
      --baseline-sha ${BASELINE_ADP_SHA}
      --comparison-sha ${COMPARISON_ADP_SHA}
      --target-config-dir ./test/smp/regression/adp/
      --submission-metadata submission_metadata
    # Wait for job to complete.
    - ./smp --team-id ${SMP_TEAM_ID} --aws-named-profile ${AWS_NAMED_PROFILE}
      job status
      --wait
      --wait-delay-seconds 60
      --submission-metadata submission_metadata
    # Pull the analysis report and output it to stdout.
    - ./smp --team-id ${SMP_TEAM_ID} --aws-named-profile ${AWS_NAMED_PROFILE}
      job sync
      --submission-metadata submission_metadata
      --output-path outputs
    # Post the report to the linked PR.
    - cat outputs/report.md | /usr/local/bin/pr-commenter --for-pr="$CI_COMMIT_REF_NAME" --header="Regression Detector (Agent Data Plane)"
    # Finally, exit 1 if the job signals a regression else 0.
    - ./smp --team-id ${SMP_TEAM_ID} --aws-named-profile ${AWS_NAMED_PROFILE}
      job result
      --submission-metadata submission_metadata

binary-size-analysis:
  stage: benchmark
  tags: ["arch:amd64"]
  # Don't run binary size analysis unless it's a PR, basically.
  rules:
    - if: !reference [.on_mq_branch, rules, if]
      when: never
    - if: !reference [.on_development_branch, rules, if]
  image: "${SALUKI_BUILD_CI_IMAGE}"
  needs:
    - build-adp-baseline-image
    - build-adp-comparison-image
  timeout: 10m
  before_script:
    - *setup-smp-env
  artifacts:
    expire_in: 1 week
    paths:
      - size-diff.csv
      - size-diff.txt
      - size-report.md
    when: always
  script:
    # Initialize our AWS credentials and login to ECR.
    - ./test/smp/configure-smp-aws-credentials.sh
    - aws ecr get-login-password --region us-west-2 --profile ${AWS_NAMED_PROFILE} | docker login --username AWS --password-stdin ${SMP_ECR_HOST}

    # Extract binaries from the container images.
    - mkdir -p binaries
    - crane export ${BASELINE_ADP_IMG} - | tar -Oxf - usr/local/bin/agent-data-plane > binaries/adp-baseline
    - crane export ${COMPARISON_ADP_IMG} - | tar -Oxf - usr/local/bin/agent-data-plane > binaries/adp-comparison

    # Run the analysis script to generate bloaty output, markdown report, and check threshold.
    # The script exits with code 1 if size increased by more than 5%.
    - python3 ./test/one-off/analyze-binary-size.py
      --baseline-binary binaries/adp-baseline
      --comparison-binary binaries/adp-comparison
      --baseline-sha ${BASELINE_ADP_SHA}
      --comparison-sha ${COMPARISON_ADP_SHA}
      --bloaty-path /usr/local/bin/bloaty
      --output-report size-report.md
      --output-csv size-diff.csv
      --output-txt size-diff.txt
      --threshold 5

    # Post the report to the linked PR.
    - cat size-report.md | /usr/local/bin/pr-commenter --for-pr="$CI_COMMIT_REF_NAME" --header="Binary Size Analysis (Agent Data Plane)"
