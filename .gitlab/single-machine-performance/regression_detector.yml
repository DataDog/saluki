regression_detector:
  stage: test
  needs:
    - build-agent-data-plane-baseline-docker
    - build-agent-data-plane-comparison-docker
  image: "${SALUKI_BUILD_CI_IMAGE}"
  script:
    # # Ensure output files exist for artifact downloads step
    # - mkdir outputs              # Also needed for smp job sync step
    # - touch outputs/report.md    # Will be emitted by smp job sync
    # - touch outputs/report.html  # Will be emitted by smp job sync
    # # Compute merge base of current commit and `main`
    # - git fetch origin
    # - SMP_BASE_BRANCH=$(inv release.get-release-json-value base_branch)
    # - echo "Looking for merge base for branch ${SMP_BASE_BRANCH}"
    # - SMP_MERGE_BASE=$(git merge-base ${CI_COMMIT_SHA} origin/${SMP_BASE_BRANCH})
    # - echo "Merge base is ${SMP_MERGE_BASE}"
    # Setup AWS credentials for single-machine-performance AWS account
    - AWS_NAMED_PROFILE="single-machine-performance"
    - SMP_ACCOUNT_ID=$(aws ssm get-parameter --region us-east-1 --name ci.datadog-agent.single-machine-performance-account-id --with-decryption --query "Parameter.Value" --out text)
    - SMP_ECR_URL=${SMP_ACCOUNT_ID}.dkr.ecr.us-west-2.amazonaws.com
    - SMP_AGENT_TEAM_ID=$(aws ssm get-parameter --region us-east-1 --name ci.datadog-agent.single-machine-performance-agent-team-id --with-decryption --query "Parameter.Value" --out text)
    - SMP_API=$(aws ssm get-parameter --region us-east-1 --name ci.datadog-agent.single-machine-performance-api --with-decryption --query "Parameter.Value" --out text)
    - aws configure set aws_access_key_id $(aws ssm get-parameter --region us-east-1 --name ci.datadog-agent.single-machine-performance-bot-access-key-id --with-decryption --query "Parameter.Value" --out text) --profile ${AWS_NAMED_PROFILE}
    - aws configure set aws_secret_access_key $(aws ssm get-parameter --region us-east-1 --name ci.datadog-agent.single-machine-performance-bot-access-key --with-decryption --query "Parameter.Value" --out text) --profile ${AWS_NAMED_PROFILE}
    - aws configure set region us-west-2 --profile ${AWS_NAMED_PROFILE}
